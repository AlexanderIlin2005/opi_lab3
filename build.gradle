plugins {
    id 'java'
    id 'war'
    id 'distribution'
}

group = 'sasailin'
version = '1.0'

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

repositories {
    mavenCentral()
}

dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter:5.9.3'
    testImplementation 'com.h2database:h2:2.2.224'

    compileOnly 'org.projectlombok:lombok:1.18.12'
    annotationProcessor 'org.projectlombok:lombok:1.18.12'

    compileOnly 'javax:javaee-api:8.0'

    implementation 'commons-codec:commons-codec:1.11'
    implementation 'io.jsonwebtoken:jjwt:0.9.1'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.2'

    implementation 'javax.persistence:javax.persistence-api:2.2'
    implementation 'org.postgresql:postgresql:42.5.1'
    implementation 'org.hibernate:hibernate-core:5.4.20.Final'
    implementation 'org.hibernate.validator:hibernate-validator:6.1.6.Final'
}

tasks.withType(JavaCompile) {
    options.annotationProcessorGeneratedSourcesDirectory = file("$buildDir/generated/sources/annotationProcessor/java/main")
}

war {
    archiveFileName = 'lab4.war'
}

// =============== 1) compile (done)================

// –ü—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: ./gradlew compile –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å compileJavaTask
tasks.register('compile') {
    group = 'build'
    description = '–ê–ª–∏–∞—Å –¥–ª—è compileJavaTask'
    dependsOn 'compileJavaTask'
}

task compileJavaTask {
    group = 'build'
    description = '–ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞'
    dependsOn 'compileJava' // –ó–∞–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏ compileJava
}

// =============== 2) build (done)================

tasks.register('build_') {
    group = 'build'
    description = '–ê–ª–∏–∞—Å –¥–ª—è buildProject'
    dependsOn 'buildProject'
}

task buildProject {
    dependsOn compileJavaTask // –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç compileJavaTask
    dependsOn war // –í–∫–ª—é—á–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ war-–∞—Ä—Ö–∏–≤–∞ –≤ build
    doLast {
        println '–ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω –∏ —É–ø–∞–∫–æ–≤–∞–Ω.'
    }
}

// =============== 3) clean(done) ================
clean {
    doLast {
        delete rootProject.buildDir
        println '–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.'
    }
}

// =============== 4) test (done in gradle, tests must be written)================
test {
    useJUnitPlatform() // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è JUnit 5
    testLogging {
        events "passed", "skipped", "failed"
    }
    dependsOn compileJavaTask // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏
}

// =============== 5) music (done)================
task music {
    dependsOn buildProject
    group = 'custom'
    description = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏'
    doLast {
        println 'üéµ –ó–∞–≤–µ—Ä—à–µ–Ω–æ! –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏...'
        def os = System.getProperty("os.name").toLowerCase()
        if (os.contains("windows")) {
            exec { commandLine 'cmd', '/c', 'start', 'music.mp3' }
        } else if (os.contains("mac")) {
            exec { commandLine 'open', 'music.mp3' }
        } else {
            exec { commandLine 'xdg-open', 'music.mp3' }
        }
    }
}

// =============== 6) native2ascii (done)================
task native2asciiAll {
    group = 'conversion'
    description = '–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ—Ö JSON-—Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç ASCII –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'

    def srcDir = file('src/main/angular/lab-app/src/assets/i18n')
    def destDir = file("$buildDir/native2ascii/i18n/")

    inputs.dir srcDir
    outputs.dir destDir

    doLast {
        destDir.mkdirs()

        fileTree(dir: srcDir, include: '*.json').each { File srcFile ->
            def destFileName = srcFile.name.replace('.json', '.properties')
            def destFile = new File(destDir, destFileName)

            println "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: ${srcFile.name} -> ${destFile.name}"

            exec {
                commandLine 'native2ascii', '-encoding', 'UTF-8', srcFile.absolutePath, destFile.absolutePath
            }
        }
    }
}




// =============== 7) xml (done) ================
task xml {
    group = 'verification'
    description = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö XML —Ñ–∞–π–ª–æ–≤ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å'
    doLast {
        fileTree(dir: 'src', include: '**/*.xml').each { File xmlFile ->
            println "–í–∞–ª–∏–¥–∞—Ü–∏—è: ${xmlFile}"
            try {
                def factory = javax.xml.parsers.DocumentBuilderFactory.newInstance()
                def builder = factory.newDocumentBuilder()
                builder.parse(xmlFile)
            } catch (Exception e) {
                println "‚ùå XML invalid: ${xmlFile}"
            }
        }
    }
}

// =============== 8) doc (done) ================
task doc {
    dependsOn javadoc
    doLast {
        def manifestFile = file("$buildDir/tmp/MANIFEST.MF")
        manifestFile.parentFile.mkdirs()
        def files = fileTree('src').matching { include '**/*.java' }

        manifestFile.withWriter { writer ->
            files.each { f ->
                def relPath = project.relativePath(f)
                def md5 = f.bytes.encodeHex().toString().substring(0, 32)
                def sha1 = f.bytes.encodeHex().toString().substring(0, 40)
                writer.println("${relPath}-MD5: ${md5}")
                writer.println("${relPath}-SHA1: ${sha1}")

                // –í—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª:
                println "${relPath}"
                println "  MD5 : ${md5}"
                println "  SHA1: ${sha1}"
            }
        }

        println 'MD5, SHA-1 –∏ Javadoc –¥–æ–±–∞–≤–ª–µ–Ω—ã.'
    }
}



// =============== 9) scp (done) ================
task scp {
    dependsOn buildProject
    doLast {
        println "–û—Ç–∫—Ä—ã–≤–∞—é —Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ SCP..."

        commandLine 'open', '-a', 'Terminal', './scp_upload.sh'
    }
}




// =============== 10) env ================
task env {
    def params = file('env.properties').readLines()
    doLast {
        javaexec {
            executable = params.find { it.startsWith('java=') }?.split('=')[1]
            jvmArgs = params.findAll { it.startsWith('args=') }*.split('=')[1]
            classpath = sourceSets.main.runtimeClasspath
            if (project.hasProperty("mainClassName")) {
                mainClass = mainClassName
            } else {
                println "mainClassName –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∑–∞–ø—É—Å–∫ –ø—Ä–æ–ø—É—â–µ–Ω."
            }
        }
    }
}

// =============== 11) report (done) ================
task report {
    dependsOn test
    doLast {
        def reportDir = file("reports/test-results")
        reportDir.mkdirs()

        copy {
            from "build/test-results/test"
            into reportDir
            include "TEST-*.xml"
        }

        def reportFiles = fileTree(reportDir).matching {
            include "TEST-*.xml"
        }

        if (reportFiles.size() == 0) {
            println "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –æ—Ç—á–µ—Ç–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ git."
            return
        }

        // –¢–µ–ø–µ—Ä—å git add –∏–∑ –ø–∞–ø–∫–∏ reports/test-results
        exec {
            commandLine 'git', 'add', 'reports/test-results'
        }


        exec {
            commandLine 'git', 'commit', '-m', '–î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—á–µ—Ç –æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤'
            ignoreExitValue true  // –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
        }
        println "–û—Ç—á—ë—Ç—ã —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ git –∏–∑ –ø–∞–ø–∫–∏ ${reportDir}"
    }
}




// =============== 12) alt ================
task alt {
    dependsOn buildProject
    doLast {
        def altSrc = file('src_alt')
        copy {
            from 'src'
            into altSrc
            include '**/*.java'
            filter { line -> line.replaceAll('Main', 'MainAlt').replaceAll('myVar', 'myAltVar') }
        }
        println '–°–æ–∑–¥–∞–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞.'
    }
}

// =============== 13) history(done) ================
task history {
    doLast {
        def success = false
        while (!success) {
            def result = exec {
                ignoreExitValue = true
                commandLine './gradlew', 'compileJava'
            }
            if (result.exitValue == 0) {
                println "‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞—é—â–∞—è –≤–µ—Ä—Å–∏—è."
                success = true
            } else {
                exec {
                    commandLine 'git', 'reset', '--hard', 'HEAD~1'
                }
                println "üîÅ –û—Ç–∫–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é..."
            }
        }
    }
}

// =============== 14) team(done) ================
task team {
    doLast {
        def revisions = ['HEAD~1', 'HEAD~2', 'HEAD~3', 'HEAD~4']
        def availableRevisions = []

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Ä–µ–≤–∏–∑–∏–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        revisions.each { rev ->
            def check = ['git', 'rev-parse', '--verify', rev].execute()
            check.waitFor()
            if (check.exitValue() == 0) {
                availableRevisions << rev
            } else {
                println "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º ${rev} ‚Äî –∫–æ–º–º–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            }
        }

        if (availableRevisions.isEmpty()) {
            println "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è —Å–±–æ—Ä–∫–∏. –ó–∞–¥–∞—á–∞ team –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
            return
        }

        // –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–æ–¥ —Å–±–æ—Ä–∫–∏
        file("teamBuilds").mkdirs()

        availableRevisions.eachWithIndex { rev, i ->
            def workDir = file("teamBuilds/worktree${i}")

            // –î–æ–±–∞–≤–ª—è–µ–º worktree –Ω–∞ –Ω—É–∂–Ω—É—é —Ä–µ–≤–∏–∑–∏—é
            exec { commandLine 'git', 'worktree', 'add', workDir.absolutePath, rev }

            try {
                // –°–±–æ—Ä–∫–∞ –≤ worktree
                exec {
                    workingDir workDir
                    commandLine './gradlew', 'build'
                }

                // –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
                copy {
                    from "${workDir}/build/libs"
                    into "teamBuilds/rev${i + 1}"
                    include '*.jar'
                }
            } catch (Exception e) {
                println "–°–±–æ—Ä–∫–∞ –∏–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–ª—è ${rev}: ${e.message}"
            } finally {
                // –£–¥–∞–ª—è–µ–º worktree –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ø–µ—Ö–∞
                exec { commandLine 'git', 'worktree', 'remove', '--force', workDir.absolutePath }
            }
        }

        // –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º zip, –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –ø–∞–∫–æ–≤–∞—Ç—å
        if (file("teamBuilds").listFiles().find { it.isDirectory() && it.name.startsWith("rev") }) {
            ant.zip(destfile: "teamBuilds/team.zip", basedir: "teamBuilds") {
                fileset(dir: "teamBuilds") {
                    exclude name: "worktree*/**"
                    exclude name: "team.zip"
                }
            }

            println "–°–æ–∑–¥–∞–Ω zip-–∞—Ä—Ö–∏–≤ team.zip —Å ${availableRevisions.size()} —Ä–µ–≤–∏–∑–∏—è–º–∏."
        } else {
            println "–ù–µ—á–µ–≥–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
        }
    }
}



// =============== 15) diff ================
task diff {
    doLast {
        def paramFile = file("exclude_classes.txt").readLines()
        def diffOutput = new ByteArrayOutputStream()
        exec {
            commandLine 'git', 'diff', '--name-only'
            standardOutput = diffOutput
        }
        def changedFiles = diffOutput.toString().split('\n')
        if (changedFiles.every { f -> paramFile.every { !f.contains(it) } }) {
            exec { commandLine 'git', 'add', '.' }
            exec { commandLine 'git', 'commit', '-m', '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π' }
        }
    }
}
